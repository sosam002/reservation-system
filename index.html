<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
    <title>Reservation System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1, h2 {
            text-align: center;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .controls label {
            margin-right: 10px;
            font-weight: bold;
        }
        .controls select {
            font-size: 16px;
            padding: 5px;
        }

        .slot-list {
            max-width: 400px;
            margin: 0 auto;
        }

        .slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }
        .slot.available {
            background-color: #d4edda;
        }
        .slot.occupied {
            background-color: #f8d7da;
        }

        .slot-info {
            display: flex;
            flex-direction: column;
        }

        .slot-time-status {
            font-weight: bold;
        }

        .slot-extra-info {
            font-size: 0.9em;
            color: #555;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        .btn.reserve {
            background-color: #4CAF50;
            color: white;
        }
        .btn.cancel {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Reservation System</h1>
    <h2>Select a Date and Time Slot</h2>
    <div class="controls">
        <label for="dateSelect">Date:</label>
        <select id="dateSelect"></select>
    </div>
    <div class="slot-list" id="slots"></div>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script>
        // TODO: 실제 Supabase URL과 Anon Key로 교체하세요.
        const SUPABASE_URL = "https://yabuloopzlrxjdhtilio.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhYnVsb29wemxyeGpkaHRpbGlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1MTM0NDAsImV4cCI6MjA1MDA4OTQ0MH0.NZtWhTe4j-ec-lmX2kfdXEe5tXv4izMT72kCpGU4hm0";
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const startHour = 8;
        const endHour = 20;

        // 날짜 리스트 예시. 실제로는 원하는 날짜 배열 만들거나 동적으로 생성 가능
        const dates = [
            '2024-12-20',
            '2024-12-21',
            '2024-12-27'
        ];

        const dateSelect = document.getElementById('dateSelect');
        const slotsDiv = document.getElementById('slots');

        // 날짜 옵션 채우기
        dates.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            dateSelect.appendChild(opt);
        });

        async function loadSlots(date) {
            // public_reservations 뷰에서 해당 날짜 데이터 가져오기
            const { data, error } = await supabaseClient
                .from('public_reservations')
                .select('*')
                .eq('date', date);

            if (error) {
                console.error(error);
                return;
            }

            // 전체 시간 슬롯 생성
            const allSlots = [];
            for (let hour = startHour; hour < endHour; hour++) {
                const timeStr = `${hour}:00 - ${hour+1}:00`;
                // 해당 timeStr에 매칭되는 예약 데이터 찾기
                const slotData = data.find(item => item.time === timeStr);
                const occupied = slotData ? slotData.occupied : false;
                const apartment = (occupied && slotData.apartment) ? slotData.apartment : null;

                allSlots.push({
                    time: timeStr,
                    occupied,
                    apartment
                });
            }

            renderSlots(allSlots);
        }

        function renderSlots(allSlots) {
            slotsDiv.innerHTML = '';
            allSlots.forEach(slot => {
                const slotDiv = document.createElement('div');
                slotDiv.className = `slot ${slot.occupied ? 'occupied' : 'available'}`;
                
                const slotInfoDiv = document.createElement('div');
                slotInfoDiv.className = 'slot-info';

                const timeStatus = document.createElement('div');
                timeStatus.className = 'slot-time-status';
                timeStatus.textContent = `${slot.time} - ${slot.occupied ? 'Occupied' : 'Available'}`;

                slotInfoDiv.appendChild(timeStatus);

                if (slot.occupied && slot.apartment) {
                    const extraInfo = document.createElement('div');
                    extraInfo.className = 'slot-extra-info';
                    extraInfo.textContent = `Reserved by ${slot.apartment}`;
                    slotInfoDiv.appendChild(extraInfo);
                }

                slotDiv.appendChild(slotInfoDiv);

                const actionDiv = document.createElement('div');

                if (slot.occupied) {
                    // 취소 버튼
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn cancel';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.onclick = () => cancelReservation(dateSelect.value, slot.time);
                    actionDiv.appendChild(cancelBtn);
                } else {
                    // 예약 버튼
                    const reserveBtn = document.createElement('button');
                    reserveBtn.className = 'btn reserve';
                    reserveBtn.textContent = 'Reserve';
                    reserveBtn.onclick = () => reserveSlot(dateSelect.value, slot.time);
                    actionDiv.appendChild(reserveBtn);
                }

                slotDiv.appendChild(actionDiv);
                slotsDiv.appendChild(slotDiv);
            });
        }

        async function reserveSlot(date, time) {
            const apartment = prompt('Enter your apartment number (e.g. 108-0501):');
            if (!/^\d{3}-\d{4}$/.test(apartment)) {
                alert('Invalid apartment number format.');
                return;
            }
            const password = prompt('Enter your password:');
            if (!password) {
                alert('Password is required.');
                return;
            }

            // reservations 테이블에 insert
            const { error } = await supabaseClient
                .from('reservations')
                .insert([{ date, time, apartment, password }]);

            if (error) {
                console.error('Reservation error:', error);
                alert('Failed to reserve.');
            } else {
                alert('Reservation successful!');
                loadSlots(dateSelect.value);
            }
        }

        async function cancelReservation(date, time) {
            const password = prompt('Enter your password to cancel:');
            if (!password) {
                alert('Password required.');
                return;
            }

            // 해당 예약 가져오기
            const { data, error } = await supabaseClient
                .from('reservations')
                .select('*')
                .eq('date', date)
                .eq('time', time)
                .single();

            if (error || !data) {
                alert('No reservation found.');
                return;
            }

            if (data.password !== password) {
                alert('Incorrect password.');
                return;
            }

            // 예약 삭제
            const { error: delError } = await supabaseClient
                .from('reservations')
                .delete()
                .eq('id', data.id);

            if (delError) {
                console.error('Cancel error:', delError);
                alert('Failed to cancel.');
            } else {
                alert('Reservation cancelled.');
                loadSlots(dateSelect.value);
            }
        }

        dateSelect.addEventListener('change', () => {
            loadSlots(dateSelect.value);
        });

        // 초기 로드
        loadSlots(dateSelect.value);
    </script>
</body>
</html>
