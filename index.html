<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        .slot {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .slot.available {
            background-color: #e0f7e9;
        }
        .slot.occupied {
            background-color: #fbe4e4;
        }
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn.reserve {
            background-color: #4CAF50;
            color: white;
        }
        .btn.cancel {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Reservation System</h1>
    <div id="slots"></div>

    <script>
        // GitHub API 설정
        const GITHUB_API_URL = 'https://api.github.com';
        const REPO_OWNER = 'your-username'; // GitHub 계정 이름
        const REPO_NAME = 'reservation-system'; // 저장소 이름
        const BRANCH_NAME = 'main'; // 브랜치 이름
        const ACCESS_TOKEN = 'your-personal-access-token'; // Personal Access Token

        // 시간 슬롯 데이터
        const startHour = 9;
        const endHour = 22;
        const slots = [];
        for (let hour = startHour; hour < endHour; hour++) {
            slots.push({
                time: `${hour}:00 - ${hour + 1}:00`,
                status: 'Available',
                user: null,
                password: null,
            });
        }

        // 예약 데이터 저장소
        const reservations = {};

        // 슬롯 렌더링
        const slotsDiv = document.getElementById('slots');
        const renderSlots = () => {
            slotsDiv.innerHTML = '';
            slots.forEach((slot, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.className = `slot ${slot.status.toLowerCase()}`;
                slotDiv.innerHTML = `
                    <span>${slot.time} - ${slot.status}</span>
                    <div>
                        ${slot.status === 'Available' 
                            ? `<button class="btn reserve" onclick="reserveSlot(${index})">Reserve</button>` 
                            : `<span>${slot.user}</span>
                               <button class="btn cancel" onclick="cancelSlot(${index})">Cancel</button>`}
                    </div>
                `;
                slotsDiv.appendChild(slotDiv);
            });
        };

        // GitHub API를 사용해 CSV 파일 업로드
        const uploadToGitHub = async (content) => {
            const filePath = 'reservations.csv'; // 저장소 내 파일 경로
            const getFileUrl = `${GITHUB_API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
            let sha = null;

            try {
                // 기존 파일 SHA 가져오기
                const getFileResponse = await fetch(getFileUrl, {
                    headers: { Authorization: `token ${ACCESS_TOKEN}` },
                });
                if (getFileResponse.ok) {
                    const fileData = await getFileResponse.json();
                    sha = fileData.sha;
                }
            } catch (error) {
                console.error('Error fetching file SHA:', error);
            }

            // 파일 업로드
            const uploadResponse = await fetch(getFileUrl, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${ACCESS_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'Update reservations',
                    content: btoa(content), // Base64로 인코딩
                    branch: BRANCH_NAME,
                    sha, // 기존 파일 SHA 필요
                }),
            });

            if (uploadResponse.ok) {
                console.log('CSV uploaded to GitHub successfully');
            } else {
                console.error('Error uploading CSV:', await uploadResponse.text());
            }
        };

        // 예약 처리
        const reserveSlot = (index) => {
            const user = prompt('Enter your apartment number (동-호):');
            if (!/^\d{3}-\d{4}$/.test(user)) {
                alert('Invalid apartment number format! Please use 000-0000 format.');
                return;
            }

            const password = prompt('Enter your password:');
            if (!password) {
                alert('Password is required.');
                return;
            }

            const slot = slots[index];
            if (slot.status === 'Available') {
                slot.status = 'Occupied';
                slot.user = user;
                slot.password = password;
                reservations[slot.time] = user;
                renderSlots();
                saveToCSV();
                alert('Reservation successful!');
            } else {
                alert('This slot is already occupied.');
            }
        };

        // 예약 데이터를 CSV로 저장
        const saveToCSV = () => {
            let csvContent = 'Time,Apartment\n';
            for (const time in reservations) {
                csvContent += `${time},${reservations[time]}\n`;
            }
            uploadToGitHub(csvContent);
        };

        // 예약 취소 처리
        const cancelSlot = (index) => {
            const password = prompt('Enter your password to cancel the reservation:');
            const slot = slots[index];

            if (slot.password === password) {
                slot.status = 'Available';
                slot.user = null;
                slot.password = null;
                delete reservations[slot.time];
                renderSlots();
                saveToCSV();
                alert('Reservation cancelled.');
            } else {
                alert('Incorrect password.');
            }
        };

        // 초기 렌더링
        renderSlots();
    </script>
</body>
</html>
